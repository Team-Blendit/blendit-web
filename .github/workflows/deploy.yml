name: deploy

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
  NCP_SECRET_KEY: ${{ secrets.NCP_SECRET_KEY }}

  OS_ENDPOINT: https://kr.object.ncloudstorage.com
  OS_BUCKET: ${{ secrets.OS_BUCKET }}
  OS_OBJECT_KEY: frontend-latest.zip

  SOURCE_DEPLOY_BASE_URL: https://vpcsourcedeploy.apigw.ntruss.com
  SOURCE_DEPLOY_PROJECT_ID_FE: ${{ secrets.SOURCE_DEPLOY_PROJECT_ID_FE }}
  SOURCE_DEPLOY_STAGE_ID_FE: ${{ secrets.SOURCE_DEPLOY_STAGE_ID_FE }}
  SOURCE_DEPLOY_SCENARIO_ID_FE: ${{ secrets.SOURCE_DEPLOY_SCENARIO_ID_FE }}

jobs:
  build_upload_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: blendit-web/package-lock.json

      - name: Install
        working-directory: blendit-web
        run: npm ci --legacy-peer-deps

      - name: Build (Next export -> out)
        working-directory: blendit-web
        run: npm run build

      - name: Pack out to zip
        shell: bash
        run: |
          set -euo pipefail
          cd blendit-web

          if [[ ! -d "out" ]]; then
            echo "ERROR: out/ not found. Check next.config.ts output:'export'."
            ls -al
            exit 1
          fi

          rm -f frontend-latest.zip
          zip -r frontend-latest.zip out

      - name: Upload zip to NCP Object Storage
        env:
          AWS_ACCESS_KEY_ID: ${{ env.NCP_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ env.NCP_SECRET_KEY }}
          AWS_DEFAULT_REGION: kr-standard
        run: |
          aws --endpoint-url=${{ env.OS_ENDPOINT }} \
            s3 cp blendit-web/frontend-latest.zip s3://${{ env.OS_BUCKET }}/${{ env.OS_OBJECT_KEY }}

      - name: Trigger SourceDeploy scenario (FRONTEND)
        shell: bash
        run: |
          set -euo pipefail

          METHOD="POST"
          URL="/api/v1/project/${SOURCE_DEPLOY_PROJECT_ID_FE}/stage/${SOURCE_DEPLOY_STAGE_ID_FE}/scenario/${SOURCE_DEPLOY_SCENARIO_ID_FE}/deploy"
          TIMESTAMP="$(date +%s%3N)"

          SIGNATURE="$(printf "%b" "${METHOD} ${URL}\n${TIMESTAMP}\n${NCP_ACCESS_KEY}" \
            | openssl dgst -sha256 -hmac "${NCP_SECRET_KEY}" -binary \
            | openssl base64 -A)"

          curl -sS -X "${METHOD}" "${SOURCE_DEPLOY_BASE_URL}${URL}" \
            -H "x-ncp-apigw-timestamp: ${TIMESTAMP}" \
            -H "x-ncp-iam-access-key: ${NCP_ACCESS_KEY}" \
            -H "x-ncp-apigw-signature-v2: ${SIGNATURE}" \
            -H "Content-Type: application/json"
