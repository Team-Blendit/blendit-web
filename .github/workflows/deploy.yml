name: deploy

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
  NCP_SECRET_KEY: ${{ secrets.NCP_SECRET_KEY }}

  OS_ENDPOINT: https://kr.object.ncloudstorage.com
  OS_BUCKET: ${{ secrets.OS_BUCKET }}
  OS_OBJECT_KEY: frontend-latest.zip

  SOURCE_DEPLOY_BASE_URL: https://vpcsourcedeploy.apigw.ntruss.com
  SOURCE_DEPLOY_PROJECT_ID_FE: ${{ secrets.SOURCE_DEPLOY_PROJECT_ID_FE }}
  SOURCE_DEPLOY_STAGE_ID_FE: ${{ secrets.SOURCE_DEPLOY_STAGE_ID_FE }}
  SOURCE_DEPLOY_SCENARIO_ID_FE: ${{ secrets.SOURCE_DEPLOY_SCENARIO_ID_FE }}

jobs:
  build_upload_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: blendit-web/package-lock.json

      - name: Install dependencies
        working-directory: blendit-web
        run: npm ci --legacy-peer-deps

      - name: Create .env file
        working-directory: blendit-web
        run: |
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env
          echo "NEXT_PUBLIC_KAKAO_CLIENT_ID=${{ secrets.NEXT_PUBLIC_KAKAO_CLIENT_ID }}" >> .env
          echo "NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}" >> .env
          echo "NEXT_PUBLIC_REDIRECT_URI=${{ secrets.NEXT_PUBLIC_REDIRECT_URI }}" >> .env

      - name: Build (Next export -> out)
        working-directory: blendit-web
        run: npm run build

      - name: Pack out to zip
        shell: bash
        run: |
          set -euo pipefail
          cd blendit-web

          if [[ ! -d "out" ]]; then
            echo "ERROR: out/ not found. Check next.config.ts output:'export'."
            ls -al
            exit 1
          fi

          rm -f frontend-latest.zip
          zip -r frontend-latest.zip out

      - name: Install AWS CLI v2 (official installer)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y curl unzip

          curl -sSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update

          aws --version

      - name: Delete old object then upload new zip (s3api put-object)
        shell: bash
        env:
          AWS_ACCESS_KEY_ID: ${{ env.NCP_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ env.NCP_SECRET_KEY }}
          AWS_DEFAULT_REGION: kr-standard
          AWS_REGION: kr-standard
          AWS_S3_ADDRESSING_STYLE: path
          AWS_EC2_METADATA_DISABLED: "true"
          # ✅ NCP Object Storage 호환 이슈 대응 (checksum 계산 방식 완화)
          AWS_REQUEST_CHECKSUM_CALCULATION: WHEN_REQUIRED
        run: |
          set -euo pipefail

          echo "== delete old frontend-latest.zip (ignore if missing) =="
          aws --region kr-standard --endpoint-url=${{ env.OS_ENDPOINT }} \
            s3 rm "s3://${{ env.OS_BUCKET }}/${{ env.OS_OBJECT_KEY }}" || true

          echo "== upload new frontend-latest.zip (put-object) =="
          aws --region kr-standard --endpoint-url=${{ env.OS_ENDPOINT }} \
            s3api put-object \
            --bucket "${{ env.OS_BUCKET }}" \
            --key "${{ env.OS_OBJECT_KEY }}" \
            --body "blendit-web/frontend-latest.zip"

      - name: Trigger SourceDeploy scenario (FRONTEND)
        shell: bash
        run: |
          set -euo pipefail

          METHOD="POST"
          URL="/api/v1/project/${SOURCE_DEPLOY_PROJECT_ID_FE}/stage/${SOURCE_DEPLOY_STAGE_ID_FE}/scenario/${SOURCE_DEPLOY_SCENARIO_ID_FE}/deploy"
          TIMESTAMP="$(python3 -c 'import time; print(int(time.time()*1000))')"

          SIGNATURE="$(printf "%b" "${METHOD} ${URL}\n${TIMESTAMP}\n${NCP_ACCESS_KEY}" \
            | openssl dgst -sha256 -hmac "${NCP_SECRET_KEY}" -binary \
            | openssl base64 -A)"

          curl -sS -X "${METHOD}" "${SOURCE_DEPLOY_BASE_URL}${URL}" \
            -H "x-ncp-apigw-timestamp: ${TIMESTAMP}" \
            -H "x-ncp-iam-access-key: ${NCP_ACCESS_KEY}" \
            -H "x-ncp-apigw-signature-v2: ${SIGNATURE}" \
            -H "Content-Type: application/json" \
            -d "{}"
